# Архитектура интеграции PropDevelopment с функциями «Умный дом»

## Основной контекст
Для реализации функций «Интеллектуальный домофон» и «Интеллектуальный шлагбаум» система PropDevelopment взаимодействует с платформой партнёра через защищённые каналы VPN по стандартам ГОСТ. Это обеспечивает безопасное и контролируемое соединение для передачи данных. Собственники могут использовать мобильное приложение для управления доступом либо напрямую взаимодействовать с оборудованием (домофоном или шлагбаумом), которое инициирует запросы через платформу партнёра.

### Участники и их роли
1. **Собственники**: Могут использовать мобильное приложение для управления функциями «Интеллектуальный домофон» и «Интеллектуальный шлагбаум» либо обращаться к этим сервисам непосредственно через оборудование.
2. **Мобильное приложение PropDevelopment (витрина)**: Направляет запросы на платформу партнёра для управления доступом через защищённый VPN-канал с использованием S-Terra и краткосрочных токенов.
3. **Оборудование домофона и шлагбаума**: Устройства инициируют запросы к платформе партнёра при распознавании лица или номера автомобиля.
4. **Платформа партнёра**: Обрабатывает запросы на основе биометрии и номеров автомобилей, управляет функциями домофона и шлагбаума через VPN.

## Поток данных
1. **Запрос на доступ от пользователя через мобильное приложение**: Пользователь инициирует запрос на открытие двери или шлагбаума через мобильное приложение, который направляет запрос на платформу партнёра через VPN.
2. **Запрос от оборудования домофона или шлагбаума**: Оборудование распознаёт пользователя (лицо или номер автомобиля) и отправляет запрос на платформу партнёра для проверки прав доступа.
3. **Проверка прав доступа на платформе партнёра**:
  - Платформа партнёра проверяет данные (биометрию или номер автомобиля) и отправляет запрос на проверку прав доступа в PropDevelopment.
  - Если доступ разрешён, платформа партнёра открывает дверь или шлагбаум.
4. **Ответ от платформы партнёра**: Платформа возвращает результат (разрешение или отказ) на мобильное приложение или инициирует действие на оборудовании.

## Основные требования к безопасности для API

### 1. Защищённое соединение по VPN (S-Terra VPN)
- Все взаимодействие между PropDevelopment и платформой партнёра осуществляется через VPN-канал S-Terra, поддерживающий стандарты ГОСТ (ГОСТ 28147-89, ГОСТ Р 34.10-2012 и ГОСТ Р 34.11-2012).
- Использование S-Terra VPN обеспечивает аутентификацию устройств и защищённое шифрование трафика, исключая возможность подключения с внешних IP-адресов.

### 2. Шифрование данных
- В дополнение к VPN, вся передача данных между PropDevelopment и платформой партнёра осуществляется через HTTPS с TLS 1.2 или выше.
- Биометрические данные и данные автомобилей шифруются и хранятся на стороне партнёра, чтобы минимизировать риски на стороне PropDevelopment.

### 3. Аутентификация и авторизация
- **OAuth 2.0** или **JWT**: Для аутентификации запросов от мобильного приложения и оборудования используется OAuth 2.0 или JWT. Все запросы от платформы партнёра аутентифицируются с использованием краткосрочных токенов.
- **Краткосрочные токены**: Используются токены с коротким сроком действия, что позволяет минимизировать риски в случае их компрометации.

### 4. Ограничение по IP-адресам через VPN
- Доступ к API PropDevelopment ограничен определёнными IP-адресами, привязанными к VPN-каналу. Подключение к системе разрешено только через VPN-клиент S-Terra, настроенный на стороне партнёра, что исключает возможность подключения через внешние IP-адреса.

### 5. Журналирование и аудит
- Все запросы и ответы между системами фиксируются в журналах PropDevelopment и партнёра для последующего аудита. Журналы содержат время запроса, идентификатор пользователя, IP-адрес и результат запроса, без хранения биометрии или номеров автомобилей.

### 6. Ограничение частоты запросов (Rate Limiting)
- Введено ограничение на частоту запросов с платформы партнёра для предотвращения атак методом подбора и перегрузки системы. Например, установлен лимит 10 запросов в секунду.

### 7. Контроль целостности данных (HMAC)
- Используется HMAC (Hash-based Message Authentication Code) для каждого запроса, чтобы убедиться, что данные не были изменены при передаче.

## Пример API запросов

### 1. Получение токена доступа
Мобильное приложение или оборудование запрашивает токен доступа для авторизации последующих запросов.

- **Эндпойнт**: `/auth/token`
- **Метод**: `POST`
- **Параметры**:
  - `client_id`: Идентификатор клиента.
  - `client_secret`: Секретный ключ клиента.
  - `grant_type`: `client_credentials`
- **Ответ**:
  - `access_token`: Токен доступа для последующих запросов.
  - `expires_in`: Время жизни токена.

### 2. Запрос на проверку доступа
Платформа партнёра направляет запрос на проверку прав доступа к домофону или шлагбауму на стороне PropDevelopment.

- **Эндпойнт**: `/api/access/verify`
- **Метод**: `POST`
- **Параметры**:
  - `access_token`: Токен для аутентификации.
  - `user_id`: Идентификатор пользователя.
  - `access_type`: Тип доступа (`intercom` или `barrier`).
  - `biometric_hash` или `car_plate_hash`: Хэш биометрических данных или номера автомобиля.
  - `timestamp`: Время запроса для предотвращения повторного воспроизведения.
- **Ответ**:
  - `access_granted`: `true` или `false`.
  - `message`: Сообщение о результате.

## Заключение
Использование S-Terra VPN для взаимодействия между PropDevelopment и платформой партнёра повышает безопасность системы, исключая несанкционированный доступ и обеспечивая безопасное шифрование данных по стандартам ГОСТ. Такая архитектура обеспечивает надёжное и защищённое взаимодействие для функций «Умного дома».
